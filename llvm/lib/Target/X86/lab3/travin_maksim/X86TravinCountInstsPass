#include "X86.h"
#include "X86InstrInfo.h"
#include "X86Subtarget.h"
#include "llvm/CodeGen/MachineFunctionPass.h"
#include "llvm/CodeGen/MachineInstrBuilder.h"

using namespace llvm;

class X86TravinCountInstsPass : public MachineFunctionPass {
public:
  static inline char ID = 0;

  X86TravinCountInstsPass() : MachineFunctionPass(ID) {}

  bool runOnMachineFunction(MachineFunction &MachFunc) override {
    DebugLoc DebugLocation;
    const TargetInstrInfo *InstrInfo = MachFunc.getSubtarget().getInstrInfo();

    for (auto &BasicBlock : MachFunc) {
      size_t Count = 0;

      for (auto &Instr : BasicBlock) {
        Count++;
      }

      const TargetRegisterClass *RC = &X86::GR64RegClass;
      Register TmpReg = MachFunc.getRegInfo().createVirtualRegister(RC);

      BuildMI(BasicBlock, BasicBlock.getFirstTerminator(), DebugLocation,
              InstrInfo->get(X86::MOV64rm), TmpReg)
          .addExternalSymbol("ic");

      BuildMI(BasicBlock, BasicBlock.getFirstTerminator(), DebugLocation,
              InstrInfo->get(X86::ADD64ri32), TmpReg)
          .addReg(TmpReg)
          .addImm(Count);
    }

    return true;
  }
};

static RegisterPass<X86TravinCountInstsPass>
    X("x86-travin-count-insts", "Pass counting number of machine instructions",
      false, false);